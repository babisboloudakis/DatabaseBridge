# Database Bridge 
 *Ανάπτυξη Λογισμικού Για Πληροφοριακά Συστήματα  
 Χειμερινό Εξάμηνο 2018 – 2019*  
 - Μπολουδάκης Χαράλαμπος 1115201500103
 - Νιάρχος Γεώργιος 1115201500109

# Περιεχόμενα  
- [Σύντομη Περιγραφή](https://github.com/babisboloudakis/DatabaseBridge#user-content-σύντομη-περιγραφή)
- [Βελτιστοποίηση ερωτημάτων](https://github.com/babisboloudakis/DatabaseBridge#%CE%B2%CE%B5%CE%BB%CF%84%CE%B9%CF%83%CF%84%CE%BF%CF%80%CE%BF%CE%AF%CE%B7%CF%83%CE%B7-%CE%B5%CF%81%CF%89%CF%84%CE%B7%CE%BC%CE%AC%CF%84%CF%89%CE%BD)
- [Παραλληλοποίηση](https://github.com/babisboloudakis/DatabaseBridge/blob/master/README.md#%CF%80%CE%B1%CF%81%CE%B1%CE%BB%CE%BB%CE%B7%CE%BB%CE%BF%CF%80%CE%BF%CE%AF%CE%B7%CF%83%CE%B7)
- [Απόδοση/Χρόνος Εκτέλεσης](https://github.com/babisboloudakis/DatabaseBridge/blob/master/README.md#%CE%B1%CF%80%CF%8C%CE%B4%CE%BF%CF%83%CE%B7-%CF%84%CE%B7%CF%82-%CF%85%CE%BB%CE%BF%CF%80%CE%BF%CE%AF%CE%B7%CF%83%CE%B7%CF%82-%CE%BC%CE%B1%CF%82)
- [Μορφή Ερωτημάτων](https://github.com/babisboloudakis/DatabaseBridge/blob/master/README.md#format-%CF%84%CF%89%CE%BD-%CE%B5%CF%81%CF%89%CF%84%CE%B7%CE%BC%CE%AC%CF%84%CF%89%CE%BD)
- [Οδηγίες Εκτέλεσης](https://github.com/babisboloudakis/DatabaseBridge#%CE%BF%CE%B4%CE%B7%CE%B3%CE%AF%CE%B5%CF%82-%CE%B5%CE%BA%CF%84%CE%AD%CE%BB%CE%B5%CF%83%CE%B7%CF%82)
- [Tests](https://github.com/babisboloudakis/DatabaseBridge#tests)
- [Hash Functions](https://github.com/babisboloudakis/DatabaseBridge#hash-functions-%CF%84%CE%B7%CF%82-radix-hash-join)
- [Ιδέες Για Βελτίωση](https://github.com/babisboloudakis/DatabaseBridge/blob/master/README.md#%CE%B9%CE%B4%CE%AD%CE%B5%CF%82-%CE%B3%CE%B9%CE%B1-%CF%80%CE%B5%CF%81%CE%B1%CE%B9%CF%84%CE%AD%CF%81%CF%89-%CE%B1%CE%BD%CE%AC%CF%80%CF%84%CF%85%CE%BE%CE%B7)

# Σύντομη Περιγραφή
Σκοπός του προγράμματος μας είναι η εκτέλεση της πράξης της σύζευξης (join) αλλά και του διάφορων φίλτρων (filter) πάνω
σε ένα σύνολο από table uint64_t με πολλές στήλες. Αναλυτικότερα, αρχικά φορτώνουμε τα δεδομένα μας στην μνήμη
και υπολογίζουμε κάποια στατιστικά για αυτά, όπως για παράδειγμα το πλήθος τον unique τιμών, μέγιστες, ελάχιστες τιμές κτλπ. Μόλις τελιώσει αυτή η διαδικασία, αρχίζουμε το parsing και την εκτέλεση των ερωτημάτων πάνω στα δεδομένα μας. Για την εκτέλεση ενός ερωτήματος, πριν αρχίσουμε να εκτελούμε τις πράξεις αναδιατάσουμε τα joins, filters κτλπ με τέτοιο τρόπο ώστε να μειώσουμε τον συνολικό χρόνο εκτέλεσης του ερωτήματος. Τέλος εκτελούμε το ερώτημα και εκτυπώνουμε τα αποτελέσματα μας.

# Βελτιστοποίηση ερωτημάτων
Για την βελτιστοποίηση των ερωτημάτων που γίνονται στα δεδομένα μας, έχουμε εφαρμόσει τα εξής
1) Εκτέλεση πρώτα των φίλτρων από τίς συζεύξεις, ανεξαρτήτως σειράς εισόδου, ώστε να ρίξουμε την διάσταση του προβλήματος
της σύζευξης, που έχει πολύ μεγαλύτερη πολυπλοκότητα από τα φίλτρα
2) Με την βοήθεια διάφορων στατιστικών πάνω στα δεδομένα, αναδιατάσουμε την σειρά εκτέλεσης των joins ανάλογα με το πλήθος των στηλών των σχέσεων (λιγότερο μέγεθος πιθανών λιγότερα mathces) ή προβλέποντας το NULL αποτέλεσμα αναδιατάσεται η αντίχτοιχη πράξη στην πρώτη θέση(οι αναδιατάξεις εφαρμόζονται μόνο στην "καλύτερη" πράξη).
3) Με τη χρήση των min, max κατά την εκτέλεση των φίλτρων, προβλέπεται το αποτέσμα αν είναι NULL ή αυτούσιο και η πράξη αυτή γίνεται σε Ο(c) ( Για παράδειγμα δεν εκτελούμε φίλτρο > 5000 για στήλη που η μέγιστη τιμή είναι 4000 )
4) Η πράξη της ζεύξης έχει παραλληλοποιήθει σε πολύ μεγάλο ποσοστό με σκοπό την επιτάχυνσή της, αφού πρόκειτε για μια πολύπλοκη διαδικασία.

# Παραλληλοποίηση
Έχουμε παραλληλοποιήσει σχεδόν πλήρως την πράξη της ζεύξης ( συγκεκριμένα την Radix Hash Join ). Αναλυτικότερα
με την χρήστη threads ( pthread ) κατασκευάσουμε τα ιστογράμματα πρώτα στα thread και στην συνέχεια φτιάχνουμε το 
συνολικό ιστόγραμμα. Στην συνέχεια με την χρήση ατομικών psum table για κάθε thread κάνουμε partition στις σχέσεις 
R και S. Αφού ολοκληρώσουμε τα παραπάνω τότε δημιουργούμε bucket jobs τα οποία αναθέτονται στα thread και το κάθε job περιλαμβάνει
την ζεύξη μεταξύ δύο bucket. Μόλις ολοκληρωθούν όλα τα jobs, τότε έχει ολοκληρωθεί και η πράξη της ζεύξης.

# Απόδοση της υλοποίησης μας
Παρακάτω φαίνετε ο μέσος χρόνος εκτέλεσης για διάφορους αριθμούς thread.

|    Threads   |     Χρόνος     |
|    :---:     |     :---:      |
|      1       |     2.4sec     |
|      2       |     1.85sec    |
|      4       |     1.5sec     |


Το πρόγραμμα εκτελέστηκε στα Linux της σχολής. Για αυτόν τον λόγο δεν είχε νόημα να εκτελέσουμε για
παραπάνω αριθμό thread.

# Format των ερωτημάτων
Η μορφή των ερωτημάτων έχει ώς εξής
```
(Relations)|(Operations)|(Results)
```
Για παράδειγμα
```
0 1 2|0.1=2.2&0.0>40&1.1=2.1&1.0=2000|0.0 1.1 2.2
```

# Οδηγίες εκτέλεσης
Έχουμε δημιουργήσει Makefile για την μεταγλώτιση και εκτέλεση του προγράμματος.
```sh
$ make
$./main
```
Υπάρχει επίσης label για καθαρισμό αντικείμενων αρχείων, και του εκτελέσιμου
```sh
$ make clean
```
Για εκτέλεση του προγράμματος με το Harness
```sh
$ bash ./harness/runTestHarness.sh
```

# Tests
Το πρόγραμμα ελέγχτηκε με την χρήση του harness από
http://sigmod18contest.db.in.tum.de/task.shtml
Τα αποτελέσματα μας είναι σώστα για όλα τα ερωτήματα ανεξαρτήτως πολυπλοκότητας.


# Hash functions της Radix Hash Join
**HashFunction1() - H1**  
Στην συνάρτηση κατακερματισμού H1 χωρίζουμε τα δεδομένα με βάση την τιμή των **ν** λιγότερο σημαντικών
bits του ανάλογου payload
```c++
 int n = 3;
```
**HashFunction2() - H2**  
Στην συνάρτηση κατακερματισμού H2 χωρίζουμε τα δεδομένα με βάση το υπόλοιπο διαίρεσης τους με έναν
πρώτο αριθμό ο οποίος είναι **defined** στην κορυφή του αρχείου. Επιλέξαμε να κάνουμε υπόλοιπο διαίρεσης
με έναν πρώτο αριθμό για να τμηματοπιήσουμε πιο ομαλά τα δεδομένα μας. Επιλέξαμε τον συγκεκριμένο αριθμό
καθώς οδηγεί στον καλύτερο χρόνο μετά απο πληθώρα δοκιμών για τα δεδομένα μας
```c++
 #define PRIME 499
```

# Ιδέες για περαιτέρω ανάπτυξη
- Παραλληλοποίηση και των υπολοίπων πράξεων. ( Για παράδειγμα τα φίλτρα )
- Βελτίωση των συναρτήσεων κατακερματισμού.
- Επανασχεδιασμός του Parser ώστε να μπορεί να επεξεργαστεί και ερωτήματα γραμμένα σε SQL.
- Υλοποίηση επιπλέον optimazation στα ερωτήματα.
